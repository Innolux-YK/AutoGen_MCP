# 新增工具 (Tool) 指南

本指南說明如何在 RAG_AGENT_LLM 專案中新增一個新的工具 (Tool)。

## 📋 概覽

在這個專案中，工具 (Tool) 是用來執行特定功能的模組，例如時間查詢、計算、SPC 分析等。每個工具都繼承自 `BaseTool` 基類，並遵循統一的介面標準。

## 🔧 需要修改的檔案

### 1. 建立新的工具類別檔案
**位置**: `tools/your_new_tool.py`

創建一個新的 Python 檔案，實作你的工具邏輯：

```python
"""
你的新工具描述
"""

import sys
import os

# 將專案根目錄加入 sys.path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from tools.base_tool import BaseTool

class YourNewTool(BaseTool):
    """你的新工具類別"""
    
    def get_name(self) -> str:
        """返回工具名稱（用於系統識別）"""
        return "your_new_tool"
    
    def get_description(self) -> str:
        """返回工具描述（用於 LLM 工具選擇）"""
        return "描述你的工具功能，說明什麼情況下會使用這個工具。"
    
    def execute(self, query: str) -> str:
        """
        執行工具的主要邏輯
        
        Args:
            query: 用戶的查詢內容
            
        Returns:
            str: 工具執行結果
        """
        try:
            # 實作你的工具邏輯
            result = "你的工具執行結果"
            return result
            
        except Exception as e:
            return f"❌ {self.get_name()} 執行錯誤：{str(e)}"
```

### 2. 更新 `tools/__init__.py`
**必須修改**: 在模組初始化檔案中匯入新工具

```python
"""
工具模組初始化文件
"""

from .base_tool import BaseTool
from .time_tool import TimeTool
from .calculation_tool import CalculationTool
from .spc_tool import SPCTool
from .edc_query_tool import EDCQueryTool
from .edc_format_tool import EDCFormatTool
from .your_new_tool import YourNewTool  # 新增這行
from .tool_manager import ToolManager

__all__ = [
    'BaseTool',
    'TimeTool',
    'CalculationTool', 
    'SPCTool',
    'EDCQueryTool',
    'EDCFormatTool',
    'YourNewTool',  # 新增這行
    'ToolManager'
]
```

### 3. 更新 `tools/tool_manager.py`
**必須修改**: 在工具管理器中註冊新工具

在檔案頂部添加匯入：
```python
from tools.your_new_tool import YourNewTool  # 新增這行
```

在 `_load_all_tools()` 方法中添加工具實例：
```python
def _load_all_tools(self) -> Dict[str, Any]:
    """載入所有工具實例"""
    tools = {}
    
    # 創建工具實例
    time_tool = TimeTool()
    calculation_tool = CalculationTool()
    spc_tool = SPCTool()
    edc_query_tool = EDCQueryTool()
    edc_format_tool = EDCFormatTool()
    your_new_tool = YourNewTool()  # 新增這行
    
    # 註冊工具
    tools[time_tool.get_name()] = time_tool
    tools[calculation_tool.get_name()] = calculation_tool
    tools[spc_tool.get_name()] = spc_tool
    tools[edc_query_tool.get_name()] = edc_query_tool
    tools[edc_format_tool.get_name()] = edc_format_tool
    tools[your_new_tool.get_name()] = your_new_tool  # 新增這行
    
    return tools
```

### 4. （可選）更新 `agents/tool_agent.py`
**視需求而定**: 如果需要在工具代理中添加特殊邏輯

在 `use_tool()` 方法中添加判斷邏輯：
```python
def use_tool(self, query: str) -> Dict[str, Any]:
    """根據查詢使用相應的工具"""
    try:
        # 判斷查詢類型並使用相應工具
        if self._is_calculation(query):
            return self._calculate(query)
        elif "時間" in query or "日期" in query:
            return self._get_time_info(query)
        elif "你的關鍵字" in query:  # 新增這行
            return self._use_your_new_tool(query)  # 新增這行
        # ... 其他判斷邏輯
```

## 📝 開發步驟

### Step 1: 分析需求
- 確定工具要解決什麼問題
- 定義輸入和輸出格式
- 確定觸發條件和關鍵字

### Step 2: 實作工具類別
1. 繼承 `BaseTool` 基類
2. 實作 `get_name()` 方法
3. 實作 `get_description()` 方法
4. 實作 `execute()` 方法

### Step 3: 註冊工具
1. 更新 `__init__.py`
2. 更新 `tool_manager.py`
3. （可選）更新 `tool_agent.py`

### Step 4: 測試工具
1. 建立單元測試
2. 整合測試
3. 在 Streamlit 介面中測試

## 🏗️ 工具架構說明

```
tools/
├── __init__.py                 # 模組初始化（需更新）
├── base_tool.py               # 基礎抽象類別
├── tool_manager.py            # 工具管理器（需更新）
├── time_tool.py               # 時間工具範例
├── calculation_tool.py        # 計算工具範例
├── spc_tool.py               # SPC 分析工具
├── edc_query_tool.py         # EDC 查詢工具
├── edc_format_tool.py        # EDC 格式工具
└── your_new_tool.py          # 你的新工具（新建）
```

## 🎯 最佳實踐

### 1. 命名規範
- 檔案名稱：`snake_case`，例如 `your_new_tool.py`
- 類別名稱：`PascalCase`，例如 `YourNewTool`
- 工具名稱：`snake_case`，例如 `"your_new_tool"`

### 2. 描述撰寫
- 清楚說明工具的功能
- 說明何時會觸發這個工具
- 包含關鍵字以便 LLM 識別

### 3. 錯誤處理
- 使用 try-catch 包裹主要邏輯
- 返回有意義的錯誤訊息
- 使用 ❌ 符號標識錯誤

### 4. 測試建議
- 建立單元測試檔案 `test_your_new_tool.py`
- 測試正常流程和異常情況
- 在實際環境中驗證整合效果

## 📚 工具範例

### 簡單工具範例：天氣查詢工具
```python
class WeatherTool(BaseTool):
    def get_name(self) -> str:
        return "weather_query"
    
    def get_description(self) -> str:
        return "查詢天氣資訊。當用戶詢問天氣、氣溫、降雨等相關問題時使用。"
    
    def execute(self, query: str) -> str:
        # 這裡可以呼叫天氣 API
        return "今天台北天氣晴朗，氣溫 25°C"
```

### 複雜工具範例：資料庫查詢工具
```python
class DatabaseTool(BaseTool):
    def __init__(self):
        super().__init__()
        self.db_connection = self._init_database()
    
    def get_name(self) -> str:
        return "database_query"
    
    def get_description(self) -> str:
        return "執行資料庫查詢。當需要查詢資料庫資料時使用。"
    
    def execute(self, query: str) -> str:
        try:
            # 解析查詢意圖
            sql_query = self._parse_query_to_sql(query)
            
            # 執行查詢
            result = self._execute_sql(sql_query)
            
            # 格式化結果
            return self._format_result(result)
            
        except Exception as e:
            return f"❌ 資料庫查詢失敗：{str(e)}"
```

## ⚠️ 注意事項

1. **路徑問題**: 確保正確設定 `sys.path`，讓工具能夠找到基類
2. **循環匯入**: 避免工具之間的循環依賴
3. **效能考量**: 對於耗時的操作，考慮添加超時機制
4. **安全性**: 對於涉及外部 API 的工具，要妥善處理認證資訊
5. **相依性**: 新工具如果需要額外的套件，記得更新 `requirements.txt`

## 🚀 完成後的驗證

1. 重新啟動應用程式
2. 檢查工具管理器是否成功載入新工具
3. 在聊天介面中測試新工具的觸發
4. 確認工具執行結果正確

遵循以上步驟，你就能成功在 RAG_AGENT_LLM 專案中新增一個功能完整的工具！
**GPT-4.1**: 🔧 **SPC CHART 診斷開始**
**查詢資訊：** 廠別:TFT6, 時間:2025-09-03 09:40:00, 玻璃ID:T65913Y7AD, 設備ID:IMRV0100, CHART ID:SPDV1400_2353_TOTAL

📊 **TRX LOG 查詢結果：**
✅ TRX LOG 查詢成功
🕐 交易時間: 2025-09-03-09.44.01.918432
📋 設備ID: IMRV0100, 玻璃ID: T65913Y7AD
📋 錯誤碼: 0, 處理時間: 152ms

### 📋 TRX LOG 基本資訊

| 項目 | 值 |
|------|-----|
| 時間戳記 | 2025-09-03-09.44.01.918432 |
| 設備ID | IMRV0100 |
| 玻璃ID | T65913Y7AD |
| 載盤ID | T6A767 |
| 錯誤碼 | 0 |
| 處理時間 | 152ms |

### 📥 輸入交易 XML
```xml
<transaction>
  <trx_id>APCSPCDT</trx_id>
  <type_id>I</type_id>
  <orig_opi_flg>N</orig_opi_flg>
  <sht_cnt>1</sht_cnt>
  <iary>
    <eqpt_id>IMRV0100</eqpt_id>
    <eqpt_unit_id>IMRV0100</eqpt_unit_id>
    <rep_unit>S</rep_unit>
    <sht_id>T65913Y7AD</sht_id>
    <slot_no>004</slot_no>
    <lot_id>T65913Y7N00</lot_id>
    <splt_id>00</splt_id>
    <crr_id>T6A767</crr_id>
    <product_id>TH3F14HK</product_id>
    <route_id>3F14HKF</route_id>
    <route_ver>00000</route_ver>
    <ope_id>2353</ope_id>
    <ope_ver>00000</ope_ver>
    <ope_no>2353</ope_no>
    <rpt_user>10007884劉慧君</rpt_user>
    <run_mode>I</run_mode>
    <owner>PROD</owner>
    <recipe_id>2353_3F14HK</recipe_id>
    <ds_recipe_id>2353_3F14HK</ds_recipe_id>
    <ac_recipe_id>2353_3F14HK</ac_recipe_id>
    <spec_check_only>Y</spec_check_only>
    <clm_date>2025-09-03</clm_date>
    <clm_time>09:44:00</clm_time>
    <iary2>
      <data_group>S</data_group>
      <data_type>X</data_type>
      <data_value>0</data_value>
      <clm_flg>Y</clm_flg>
    </iary2>
    <iary2>
      <data_group>M</data_group>
      <data_type>X</data_type>
      <data_value>0</data_value>
      <clm_flg>Y</clm_flg>
    </iary2>
    <iary2>
      <data_group>L</data_group>
      <data_type>X</data_type>
      <data_value>0</data_value>
      <clm_flg>Y</clm_flg>
    </iary2>
    <iary2>
      <data_group>O</data_group>
      <data_type>X</data_type>
      <data_value>0</data_value>
      <clm_flg>Y</clm_flg>
    </iary2>
    <iary2>
      <data_group>TOTAL</data_group>
      <data_type>X</data_type>
      <data_value>0</data_value>
      <clm_flg>Y</clm_flg>
    </iary2>
    <data_cnt>0005</data_cnt>
  </iary>
</transaction>

```

### 📤 輸出交易 XML
```xml
<transaction>
  <trx_id>APCSPCDT</trx_id>
  <type_id>O</type_id>
  <rtn_code>0000000</rtn_code>
</transaction>

```
